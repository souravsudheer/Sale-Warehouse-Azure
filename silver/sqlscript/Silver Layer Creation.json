{
	"name": "Silver Layer Creation",
	"properties": {
		"content": {
			"query": "/*\n===============================================================================\nComplete Silver Layer Creation - All Tables\n===============================================================================\nCreates all 6 silver layer tables in one script\n===============================================================================\n*/\n\n-- Create Silver Schema and Data Source\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'silver')\n    EXEC('CREATE SCHEMA silver');\nGO\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'silver_data_source')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE silver_data_source\n    WITH (\n        LOCATION = 'https://salessourcream.dfs.core.windows.net/datawarehouse/silver/',\n        CREDENTIAL = bronze_credential\n    );\nEND\nGO\n\n/*\n===============================================================================\n1. Silver CRM Customer Info\n===============================================================================\n*/\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'crm_cust_info' AND schema_id = SCHEMA_ID('silver'))\n    DROP EXTERNAL TABLE silver.crm_cust_info;\nGO\n\nCREATE EXTERNAL TABLE silver.crm_cust_info\nWITH (\n    LOCATION = 'crm_cust_info/',\n    DATA_SOURCE = silver_data_source,\n    FILE_FORMAT = csv_file_format\n)\nAS\nSELECT\n    CAST(cst_id AS INT) AS cst_id,\n    cst_key,\n    TRIM(cst_firstname) AS cst_firstname,\n    TRIM(cst_lastname) AS cst_lastname,\n    CASE \n        WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'\n        WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'\n        ELSE 'n/a'\n    END AS cst_marital_status,\n    CASE \n        WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'Female'\n        WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male'\n        ELSE 'n/a'\n    END AS cst_gndr,\n    TRY_CAST(cst_create_date AS DATE) AS cst_create_date,\n    GETDATE() AS dwh_create_date\nFROM (\n    SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY TRY_CAST(cst_create_date AS DATE) DESC) AS flag_last\n    FROM bronze.crm_cust_info\n    WHERE cst_id IS NOT NULL \n        AND cst_id != '' \n        AND TRY_CAST(cst_id AS INT) IS NOT NULL\n) t\nWHERE flag_last = 1;\nGO\n\n/*\n===============================================================================\n2. Silver CRM Product Info\n===============================================================================\n*/\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'crm_prd_info' AND schema_id = SCHEMA_ID('silver'))\n    DROP EXTERNAL TABLE silver.crm_prd_info;\nGO\n\nCREATE EXTERNAL TABLE silver.crm_prd_info\nWITH (\n    LOCATION = 'crm_prd_info/',\n    DATA_SOURCE = silver_data_source,\n    FILE_FORMAT = csv_file_format\n)\nAS\nSELECT\n    CAST(prd_id AS INT) AS prd_id,\n    REPLACE(SUBSTRING(prd_key, 1, 5), '-', '_') AS cat_id,\n    SUBSTRING(prd_key, 7, LEN(prd_key)) AS prd_key,\n    prd_nm,\n    ISNULL(TRY_CAST(prd_cost AS INT), 0) AS prd_cost,\n    CASE \n        WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain'\n        WHEN UPPER(TRIM(prd_line)) = 'R' THEN 'Road'\n        WHEN UPPER(TRIM(prd_line)) = 'S' THEN 'Other Sales'\n        WHEN UPPER(TRIM(prd_line)) = 'T' THEN 'Touring'\n        ELSE 'n/a'\n    END AS prd_line,\n    TRY_CAST(prd_start_dt AS DATE) AS prd_start_dt,\n    DATEADD(day, -1, \n        LEAD(TRY_CAST(prd_start_dt AS DATE)) OVER (\n            PARTITION BY SUBSTRING(prd_key, 7, LEN(prd_key)) \n            ORDER BY TRY_CAST(prd_start_dt AS DATE)\n        )\n    ) AS prd_end_dt,\n    GETDATE() AS dwh_create_date\nFROM bronze.crm_prd_info\nWHERE prd_id IS NOT NULL \n    AND prd_id != '' \n    AND TRY_CAST(prd_id AS INT) IS NOT NULL;\nGO\n\n/*\n===============================================================================\n3. Silver CRM Sales Details\n===============================================================================\n*/\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'crm_sales_details' AND schema_id = SCHEMA_ID('silver'))\n    DROP EXTERNAL TABLE silver.crm_sales_details;\nGO\n\nCREATE EXTERNAL TABLE silver.crm_sales_details\nWITH (\n    LOCATION = 'crm_sales_details/',\n    DATA_SOURCE = silver_data_source,\n    FILE_FORMAT = csv_file_format\n)\nAS\nSELECT \n    sls_ord_num,\n    sls_prd_key,\n    CAST(sls_cust_id AS INT) AS sls_cust_id,\n    CASE \n        WHEN sls_order_dt = '0' OR LEN(sls_order_dt) != 8 OR sls_order_dt IS NULL \n            THEN NULL\n        ELSE TRY_CAST(sls_order_dt AS DATE)\n    END AS sls_order_dt,\n    CASE \n        WHEN sls_ship_dt = '0' OR LEN(sls_ship_dt) != 8 OR sls_ship_dt IS NULL \n            THEN NULL\n        ELSE TRY_CAST(sls_ship_dt AS DATE)\n    END AS sls_ship_dt,\n    CASE \n        WHEN sls_due_dt = '0' OR LEN(sls_due_dt) != 8 OR sls_due_dt IS NULL \n            THEN NULL\n        ELSE TRY_CAST(sls_due_dt AS DATE)\n    END AS sls_due_dt,\n    -- Sales calculation with careful null handling\n    CASE \n        WHEN TRY_CAST(sls_sales AS INT) IS NULL OR TRY_CAST(sls_sales AS INT) <= 0 \n            THEN ISNULL(TRY_CAST(sls_quantity AS INT), 0) * ABS(ISNULL(TRY_CAST(sls_price AS INT), 0))\n        WHEN TRY_CAST(sls_sales AS INT) != ISNULL(TRY_CAST(sls_quantity AS INT), 0) * ABS(ISNULL(TRY_CAST(sls_price AS INT), 0))\n            THEN ISNULL(TRY_CAST(sls_quantity AS INT), 0) * ABS(ISNULL(TRY_CAST(sls_price AS INT), 0))\n        ELSE TRY_CAST(sls_sales AS INT)\n    END AS sls_sales,\n    TRY_CAST(sls_quantity AS INT) AS sls_quantity,\n    -- Price calculation with careful null handling\n    CASE \n        WHEN TRY_CAST(sls_price AS INT) IS NULL OR TRY_CAST(sls_price AS INT) <= 0 \n            THEN CASE \n                WHEN ISNULL(TRY_CAST(sls_quantity AS INT), 0) != 0 \n                    THEN TRY_CAST(sls_sales AS INT) / TRY_CAST(sls_quantity AS INT)\n                ELSE 0 \n            END\n        ELSE TRY_CAST(sls_price AS INT)\n    END AS sls_price,\n    GETDATE() AS dwh_create_date\nFROM bronze.crm_sales_details\nWHERE sls_ord_num IS NOT NULL \n    AND sls_ord_num != ''\n    AND TRY_CAST(sls_cust_id AS INT) IS NOT NULL;\nGO\n\n/*\n===============================================================================\n4. Silver ERP Customer AZ12\n===============================================================================\n*/\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'erp_cust_az12' AND schema_id = SCHEMA_ID('silver'))\n    DROP EXTERNAL TABLE silver.erp_cust_az12;\nGO\n\nCREATE EXTERNAL TABLE silver.erp_cust_az12\nWITH (\n    LOCATION = 'erp_cust_az12/',\n    DATA_SOURCE = silver_data_source,\n    FILE_FORMAT = csv_file_format\n)\nAS\nSELECT\n    CASE\n        WHEN cid LIKE 'NAS%' THEN SUBSTRING(cid, 4, LEN(cid))\n        ELSE cid\n    END AS cid, \n    CASE\n        WHEN TRY_CAST(bdate AS DATE) > GETDATE() THEN NULL\n        ELSE TRY_CAST(bdate AS DATE)\n    END AS bdate,\n    CASE\n        WHEN UPPER(TRIM(gen)) IN ('F', 'FEMALE') THEN 'Female'\n        WHEN UPPER(TRIM(gen)) IN ('M', 'MALE') THEN 'Male'\n        ELSE 'n/a'\n    END AS gen,\n    GETDATE() AS dwh_create_date\nFROM bronze.erp_cust_az12\nWHERE cid IS NOT NULL AND cid != '';\nGO\n\n/*\n===============================================================================\n5. Silver ERP Location A101\n===============================================================================\n*/\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'erp_loc_a101' AND schema_id = SCHEMA_ID('silver'))\n    DROP EXTERNAL TABLE silver.erp_loc_a101;\nGO\n\nCREATE EXTERNAL TABLE silver.erp_loc_a101\nWITH (\n    LOCATION = 'erp_loc_a101/',\n    DATA_SOURCE = silver_data_source,\n    FILE_FORMAT = csv_file_format\n)\nAS\nSELECT\n    REPLACE(cid, '-', '') AS cid, \n    CASE\n        WHEN TRIM(cntry) = 'DE' THEN 'Germany'\n        WHEN TRIM(cntry) IN ('US', 'USA') THEN 'United States'\n        WHEN TRIM(cntry) = '' OR cntry IS NULL THEN 'n/a'\n        ELSE TRIM(cntry)\n    END AS cntry,\n    GETDATE() AS dwh_create_date\nFROM bronze.erp_loc_a101\nWHERE cid IS NOT NULL AND cid != '';\nGO\n\n/*\n===============================================================================\n6. Silver ERP Product Category G1V2\n===============================================================================\n*/\nIF EXISTS (SELECT * FROM sys.external_tables WHERE name = 'erp_px_cat_g1v2' AND schema_id = SCHEMA_ID('silver'))\n    DROP EXTERNAL TABLE silver.erp_px_cat_g1v2;\nGO\n\nCREATE EXTERNAL TABLE silver.erp_px_cat_g1v2\nWITH (\n    LOCATION = 'erp_px_cat_g1v2/',\n    DATA_SOURCE = silver_data_source,\n    FILE_FORMAT = csv_file_format\n)\nAS\nSELECT\n    id,\n    cat,\n    subcat,\n    maintenance,\n    GETDATE() AS dwh_create_date\nFROM bronze.erp_px_cat_g1v2\nWHERE id IS NOT NULL AND id != '';\nGO\n\n/*\n===============================================================================\nFinal Summary - Verify All Silver Tables\n===============================================================================\n*/\nSELECT 'crm_cust_info' as table_name, COUNT(*) as row_count FROM silver.crm_cust_info\nUNION ALL\nSELECT 'crm_prd_info', COUNT(*) FROM silver.crm_prd_info\nUNION ALL\nSELECT 'crm_sales_details', COUNT(*) FROM silver.crm_sales_details\nUNION ALL\nSELECT 'erp_cust_az12', COUNT(*) FROM silver.erp_cust_az12\nUNION ALL\nSELECT 'erp_loc_a101', COUNT(*) FROM silver.erp_loc_a101\nUNION ALL\nSELECT 'erp_px_cat_g1v2', COUNT(*) FROM silver.erp_px_cat_g1v2;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "bronze_verify",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}